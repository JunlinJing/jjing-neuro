<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- SEO Meta Tags -->

    <title>A Comprehensive Guide to fMRI Data Preprocessing | Jim Jing</title>
    <meta property="og:title" content="A Comprehensive Guide to fMRI Data Preprocessing | Jim Jing" />
    <meta name="twitter:title" content="A Comprehensive Guide to fMRI Data Preprocessing | Jim Jing" />



    <meta name="description" content="A step-by-step tutorial on preprocessing functional MRI data, covering motion correction, slice timing, spatial normalization, and more." />
    <meta property="og:description" content="A step-by-step tutorial on preprocessing functional MRI data, covering motion correction, slice timing, spatial normalization, and more." />
    <meta name="twitter:description" content="A step-by-step tutorial on preprocessing functional MRI data, covering motion correction, slice timing, spatial normalization, and more." />


<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:4000/blog/fmri-preprocessing-guide/" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@JimJing1997" />



<!-- Structured Data -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "A Comprehensive Guide to fMRI Data Preprocessing",
    "description": "A step-by-step tutorial on preprocessing functional MRI data, covering motion correction, slice timing, spatial normalization, and more.",
    "url": "http://localhost:4000/blog/fmri-preprocessing-guide/",
    
    "datePublished": "2025-05-17T00:00:00+02:00",
    "dateModified": "2025-05-17T00:00:00+02:00",
    
    "author": {
        "@type": "Person",
        "name": "Jim Jing",
        "url": "http://localhost:4000"
    }
}</script> 

    <!-- Styles -->
    <link rel="stylesheet" href="/jjing-neuro/assets/css/theme.css">
    <link rel="stylesheet" href="/jjing-neuro/assets/css/style.css">
    <link rel="stylesheet" href="/jjing-neuro/assets/css/custom.css">
    <link rel="stylesheet" href="/jjing-neuro/assets/css/dark-mode-fixes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/jjing-neuro/assets/images/favicon.png">
    <link rel="apple-touch-icon" href="/jjing-neuro/assets/images/apple-touch-icon.png">
    
    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/jjing-neuro/feed.xml" title="Jim Jing" />
</head>
<body>
    <div class="wrapper">
        <header>
            <nav class="nav">
    <div class="nav-container">
        <ul class="nav-list">
            
                <li class="nav-item">
                    <a class="nav-link" href="/jjing-neuro/">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </li>
            

            
                
                    <li class="nav-item">
                        <a class="nav-link" href="/jjing-neuro/about">
                            <i class="fas fa-user"></i>
                            <span>About</span>
                        </a>
                    </li>
                
            
            
            
                
                    <li class="nav-item">
                        <a class="nav-link" href="/jjing-neuro/research">
                            <i class="fas fa-flask"></i>
                            <span>Research</span>
                        </a>
                    </li>
                
            
            
            
                
                    <li class="nav-item">
                        <a class="nav-link" href="/jjing-neuro/publications">
                            <i class="fas fa-book"></i>
                            <span>Publications</span>
                        </a>
                    </li>
                
            

            
                
                    <li class="nav-item">
                        <a class="nav-link" href="/jjing-neuro/projects">
                            <i class="fas fa-code-branch"></i>
                            <span>Projects</span>
                        </a>
                    </li>
                
            

            
                
                    <li class="nav-item">
                        <a class="nav-link" href="/jjing-neuro/blog">
                            <i class="fas fa-pen-nib"></i>
                            <span>Blog</span>
                        </a>
                    </li>
                
            

            <li class="nav-item">
                <button id="dark-mode-toggle" class="nav-link dark-mode-toggle" aria-label="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </button>
            </li>
        </ul>
    </div>
</nav>

<style>
    .nav-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .nav-list {
        display: flex;
        justify-content: center;
        align-items: center;
        list-style: none;
        padding: 0;
        margin: 0;
        flex-wrap: wrap;
    }

    .nav-item {
        margin: 0 5px;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 10px 20px;
        color: var(--nav-text);
        text-decoration: none;
        border-radius: 20px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.05);
        border: none;
        cursor: pointer;
        font-size: inherit;
        font-family: inherit;
    }

    .nav-link i {
        margin-right: 8px;
        font-size: 1.1em;
    }

    .nav-link span {
        font-size: 1em;
    }

    .nav-link:hover {
        background: #4e4376;
        color: white;
        transform: translateY(-2px);
    }

    .dark-mode-toggle {
        background: transparent;
        border: 1px solid var(--border-color);
        padding: 10px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .dark-mode-toggle i {
        margin: 0;
    }

    @media (max-width: 768px) {
        .nav-list {
            flex-direction: column;
            gap: 10px;
        }

        .nav-item {
            width: 100%;
            margin: 5px 0;
        }

        .nav-link {
            justify-content: center;
        }
    }
</style>

        </header>
        
        <main>
            <style>
/* 强制隐藏重复标题 */
.post-content > h1:first-of-type {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    overflow: hidden !important;
}

/* 隐藏导航栏中的标题 */
nav + h1, 
.nav + h1, 
header + h1, 
.header + h1, 
.wrapper > h1:first-of-type,
main > h1:first-of-type:not(.post-title) {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    overflow: hidden !important;
}
</style>

<article class="post">
    <!-- SEO Meta Tags -->

    <title>A Comprehensive Guide to fMRI Data Preprocessing | Jim Jing</title>
    <meta property="og:title" content="A Comprehensive Guide to fMRI Data Preprocessing | Jim Jing" />
    <meta name="twitter:title" content="A Comprehensive Guide to fMRI Data Preprocessing | Jim Jing" />



    <meta name="description" content="A step-by-step tutorial on preprocessing functional MRI data, covering motion correction, slice timing, spatial normalization, and more." />
    <meta property="og:description" content="A step-by-step tutorial on preprocessing functional MRI data, covering motion correction, slice timing, spatial normalization, and more." />
    <meta name="twitter:description" content="A step-by-step tutorial on preprocessing functional MRI data, covering motion correction, slice timing, spatial normalization, and more." />


<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:4000/blog/fmri-preprocessing-guide/" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@JimJing1997" />



<!-- Structured Data -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "A Comprehensive Guide to fMRI Data Preprocessing",
    "description": "A step-by-step tutorial on preprocessing functional MRI data, covering motion correction, slice timing, spatial normalization, and more.",
    "url": "http://localhost:4000/blog/fmri-preprocessing-guide/",
    
    "datePublished": "2025-05-17T00:00:00+02:00",
    "dateModified": "2025-05-17T00:00:00+02:00",
    
    "author": {
        "@type": "Person",
        "name": "Jim Jing",
        "url": "http://localhost:4000"
    }
}</script> 
    
    <header class="post-header">
        
        
        <h1 class="post-title">A Comprehensive Guide to fMRI Data Preprocessing</h1>
        
        <div class="post-meta">
            <time datetime="2025-05-17T00:00:00+02:00">
                <i class="far fa-calendar-alt"></i> May 17, 2025
            </time>
            
                • <span><i class="far fa-user"></i> Jim Jing</span>
            
            
            <div class="post-categories">
                
                <a href="/jjing-neuro/categories#tutorials" class="category">tutorials</a>
                
            </div>
            
            
            
            <div class="post-tags">
                
                    
                    <a href="/jjing-neuro/tags#fMRI" class="tag">
                        <i class="fas fa-tag"></i> fMRI
                    </a>
                    
                    <a href="/jjing-neuro/tags#preprocessing" class="tag">
                        <i class="fas fa-tag"></i> preprocessing
                    </a>
                    
                    <a href="/jjing-neuro/tags#neuroimaging" class="tag">
                        <i class="fas fa-tag"></i> neuroimaging
                    </a>
                    
                    <a href="/jjing-neuro/tags#tutorial" class="tag">
                        <i class="fas fa-tag"></i> tutorial
                    </a>
                    
                
            </div>
            
            
            <span class="reading-time" title="Estimated reading time">
                <i class="far fa-clock"></i>
                
                
                5 min read
            </span>
        </div>
    </header>

    

    <div class="post-wrapper">
        <aside class="table-of-contents" id="toc">
            <div class="toc-title">Table of Contents</div>
            <div id="toc-content"></div>
        </aside>

        <div class="post-content">
            <h1 id="a-comprehensive-guide-to-fmri-data-preprocessing">A Comprehensive Guide to fMRI Data Preprocessing</h1>

<p>Preprocessing is a critical step in functional MRI analysis that aims to remove unwanted sources of variation and prepare the data for statistical analysis. This tutorial covers the essential preprocessing steps for fMRI data, with practical examples using popular neuroimaging software packages.</p>

<h2 id="why-preprocessing-matters">Why Preprocessing Matters</h2>

<p>Raw fMRI data contains various artifacts and noise sources that can obscure the neural signals of interest:</p>

<ul>
  <li>Head motion during scanning</li>
  <li>Physiological noise (e.g., respiration, cardiac cycles)</li>
  <li>Scanner-related drift</li>
  <li>Timing differences between slice acquisitions</li>
  <li>Anatomical differences between subjects</li>
</ul>

<p>Effective preprocessing minimizes these confounds, enhancing our ability to detect true neural activity and make valid inferences.</p>

<h2 id="required-tools">Required Tools</h2>

<p>For this tutorial, we’ll use:</p>
<ul>
  <li><strong>FSL</strong> (FMRIB Software Library)</li>
  <li><strong>SPM</strong> (Statistical Parametric Mapping)</li>
  <li><strong>Python</strong> with the following libraries:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">nipype</code> (for workflow creation)</li>
      <li><code class="language-plaintext highlighter-rouge">nilearn</code> (for visualization)</li>
      <li><code class="language-plaintext highlighter-rouge">matplotlib</code> (for plotting)</li>
    </ul>
  </li>
</ul>

<h2 id="step-1-dicom-to-nifti-conversion">Step 1: DICOM to NIfTI Conversion</h2>

<p>fMRI data is typically acquired in DICOM format but analyzed in NIfTI format. Here’s how to convert:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.dcm2nii</span> <span class="kn">import</span> <span class="n">Dcm2niix</span>

<span class="n">converter</span> <span class="o">=</span> <span class="n">Dcm2niix</span><span class="p">()</span>
<span class="n">converter</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">source_dir</span> <span class="o">=</span> <span class="s">'path/to/dicom_dir'</span>
<span class="n">converter</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="s">'path/to/output_dir'</span>
<span class="n">converter</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">compress</span> <span class="o">=</span> <span class="s">'y'</span>
<span class="n">converter</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="step-2-removing-initial-volumes">Step 2: Removing Initial Volumes</h2>

<p>The first few volumes of an fMRI run are often discarded to allow for T1 equilibration effects:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">image</span>
<span class="n">fmri_img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">load_img</span><span class="p">(</span><span class="s">'func.nii.gz'</span><span class="p">)</span>
<span class="n">n_vols_to_remove</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">trimmed_img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">index_img</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">n_vols_to_remove</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
<span class="n">trimmed_img</span><span class="p">.</span><span class="n">to_filename</span><span class="p">(</span><span class="s">'func_trimmed.nii.gz'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="step-3-slice-timing-correction">Step 3: Slice Timing Correction</h2>

<p>Because fMRI volumes are acquired one slice at a time, different slices are actually acquired at different time points:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">spm</span>
<span class="n">slice_timing</span> <span class="o">=</span> <span class="n">spm</span><span class="p">.</span><span class="n">SliceTiming</span><span class="p">()</span>
<span class="n">slice_timing</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="s">'func_trimmed.nii.gz'</span>
<span class="n">slice_timing</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="mi">36</span>
<span class="n">slice_timing</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">time_repetition</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">slice_timing</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">time_acquisition</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mi">36</span><span class="p">)</span>
<span class="n">slice_timing</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Interleaved acquisition
</span><span class="n">slice_timing</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">slice_timing</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="step-4-motion-correction">Step 4: Motion Correction</h2>

<p>Subject motion during scanning is one of the biggest sources of noise in fMRI:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">fsl</span>
<span class="n">mcflirt</span> <span class="o">=</span> <span class="n">fsl</span><span class="p">.</span><span class="n">MCFLIRT</span><span class="p">()</span>
<span class="n">mcflirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="s">'slice_timing_corrected.nii.gz'</span>
<span class="n">mcflirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">cost</span> <span class="o">=</span> <span class="s">'mutualinfo'</span>
<span class="n">mcflirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">ref_vol</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">mcflirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">save_plots</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">mcflirt</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<p>Visualizing motion parameters:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">motion_params</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">'motion_parameters.par'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">motion_params</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">'Translation (mm)'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">plot</span><span class="p">(</span><span class="n">motion_params</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">'Rotation (rad)'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">'Volume'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">'motion_parameters.png'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="step-5-spatial-normalization">Step 5: Spatial Normalization</h2>

<p>To compare brain activity across subjects, individual brains must be transformed to a standard space:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># First, extract brain from structural image
</span><span class="n">bet</span> <span class="o">=</span> <span class="n">fsl</span><span class="p">.</span><span class="n">BET</span><span class="p">()</span>
<span class="n">bet</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="s">'structural.nii.gz'</span>
<span class="n">bet</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="s">'structural_brain.nii.gz'</span>
<span class="n">bet</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">frac</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">bet</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Register functional to structural
</span><span class="n">flirt</span> <span class="o">=</span> <span class="n">fsl</span><span class="p">.</span><span class="n">FLIRT</span><span class="p">()</span>
<span class="n">flirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="s">'motion_corrected.nii.gz'</span>
<span class="n">flirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">reference</span> <span class="o">=</span> <span class="s">'structural_brain.nii.gz'</span>
<span class="n">flirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="s">'func2struct.nii.gz'</span>
<span class="n">flirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">out_matrix_file</span> <span class="o">=</span> <span class="s">'func2struct.mat'</span>
<span class="n">flirt</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Register structural to standard space (MNI)
</span><span class="n">flirt</span> <span class="o">=</span> <span class="n">fsl</span><span class="p">.</span><span class="n">FLIRT</span><span class="p">()</span>
<span class="n">flirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="s">'structural_brain.nii.gz'</span>
<span class="n">flirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">reference</span> <span class="o">=</span> <span class="s">'MNI152_T1_2mm_brain.nii.gz'</span>
<span class="n">flirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="s">'struct2mni.nii.gz'</span>
<span class="n">flirt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">out_matrix_file</span> <span class="o">=</span> <span class="s">'struct2mni.mat'</span>
<span class="n">flirt</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Apply transformations to functional data
</span><span class="n">concat_xfm</span> <span class="o">=</span> <span class="n">fsl</span><span class="p">.</span><span class="n">ConvertXFM</span><span class="p">()</span>
<span class="n">concat_xfm</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="s">'func2struct.mat'</span>
<span class="n">concat_xfm</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_file2</span> <span class="o">=</span> <span class="s">'struct2mni.mat'</span>
<span class="n">concat_xfm</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">concat_xfm</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">concat_xfm</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="s">'func2mni.mat'</span>
<span class="n">concat_xfm</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>

<span class="n">apply_xfm</span> <span class="o">=</span> <span class="n">fsl</span><span class="p">.</span><span class="n">ApplyXFM</span><span class="p">()</span>
<span class="n">apply_xfm</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="s">'motion_corrected.nii.gz'</span>
<span class="n">apply_xfm</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">reference</span> <span class="o">=</span> <span class="s">'MNI152_T1_2mm_brain.nii.gz'</span>
<span class="n">apply_xfm</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_matrix_file</span> <span class="o">=</span> <span class="s">'func2mni.mat'</span>
<span class="n">apply_xfm</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="s">'func_mni.nii.gz'</span>
<span class="n">apply_xfm</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="step-6-spatial-smoothing">Step 6: Spatial Smoothing</h2>

<p>Smoothing increases signal-to-noise ratio and accommodates anatomical variability:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">smooth</span> <span class="o">=</span> <span class="n">fsl</span><span class="p">.</span><span class="n">Smooth</span><span class="p">()</span>
<span class="n">smooth</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="s">'func_mni.nii.gz'</span>
<span class="n">smooth</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="mf">6.0</span>
<span class="n">smooth</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="step-7-temporal-filtering">Step 7: Temporal Filtering</h2>

<p>Remove low-frequency drifts and high-frequency noise:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filt</span> <span class="o">=</span> <span class="n">fsl</span><span class="p">.</span><span class="n">TemporalFilter</span><span class="p">()</span>
<span class="n">filt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="s">'smoothed_func.nii.gz'</span>
<span class="n">filt</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">highpass_sigma</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># In seconds for 100s cutoff
</span><span class="n">filt</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="step-8-intensity-normalization">Step 8: Intensity Normalization</h2>

<p>Scale voxel intensities to enable meaningful comparisons:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">image</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">load_img</span><span class="p">(</span><span class="s">'filtered_func.nii.gz'</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="n">mean</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">mean</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">norm_img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">new_img_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">norm_img</span><span class="p">.</span><span class="n">to_filename</span><span class="p">(</span><span class="s">'normalized_func.nii.gz'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="step-9-quality-control">Step 9: Quality Control</h2>

<p>Always check your preprocessing results for anomalies:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># Create a report of mean, std, and tSNR images
</span><span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">load_img</span><span class="p">(</span><span class="s">'normalized_func.nii.gz'</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="n">mean_img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">new_img_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">std_img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">new_img_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">tsnr_img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">new_img_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">data</span><span class="p">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">plotting</span><span class="p">.</span><span class="n">plot_epi</span><span class="p">(</span><span class="n">mean_img</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s">'Mean Image'</span><span class="p">)</span>
<span class="n">plotting</span><span class="p">.</span><span class="n">plot_epi</span><span class="p">(</span><span class="n">std_img</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s">'Standard Deviation'</span><span class="p">)</span>
<span class="n">plotting</span><span class="p">.</span><span class="n">plot_epi</span><span class="p">(</span><span class="n">tsnr_img</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s">'tSNR'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">'quality_control.png'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="common-preprocessing-workflows">Common Preprocessing Workflows</h2>

<p>Different research questions may require different preprocessing steps. Here are some common workflows:</p>

<ol>
  <li><strong>Task-based fMRI</strong>:
    <ul>
      <li>Slice timing correction</li>
      <li>Motion correction</li>
      <li>Spatial normalization</li>
      <li>Spatial smoothing (5-8mm FWHM)</li>
      <li>Temporal filtering (high-pass, &gt;0.01Hz)</li>
    </ul>
  </li>
  <li><strong>Resting-state fMRI</strong>:
    <ul>
      <li>Motion correction</li>
      <li>Regress out nuisance variables (CSF, WM signals, motion parameters)</li>
      <li>Spatial normalization</li>
      <li>Spatial smoothing (4-6mm FWHM)</li>
      <li>Bandpass filtering (0.01-0.08Hz)</li>
    </ul>
  </li>
  <li><strong>Multi-echo fMRI</strong>:
    <ul>
      <li>Combine echoes using optimal combination or ICA-based denoising</li>
      <li>Motion correction</li>
      <li>Spatial normalization</li>
      <li>Minimal or no spatial smoothing</li>
    </ul>
  </li>
</ol>

<h2 id="conclusion">Conclusion</h2>

<p>Proper preprocessing is essential for reliable fMRI analysis. The choices made during preprocessing can significantly impact your results, so it’s crucial to understand each step and make informed decisions based on your specific research question.</p>

<p>In future tutorials, we’ll cover statistical analysis methods for extracting meaningful patterns from your preprocessed fMRI data.</p>

<h2 id="references">References</h2>

<ol>
  <li>Poldrack, R. A., Mumford, J. A., &amp; Nichols, T. E. (2011). Handbook of functional MRI data analysis. Cambridge University Press.</li>
  <li>Jenkinson, M., Beckmann, C. F., Behrens, T. E., Woolrich, M. W., &amp; Smith, S. M. (2012). FSL. Neuroimage, 62(2), 782-790.</li>
  <li>Esteban, O., Markiewicz, C. J., Blair, R. W., et al. (2019). fMRIPrep: a robust preprocessing pipeline for functional MRI. Nature Methods, 16(1), 111-116.</li>
</ol>

        </div>
    </div>

    <div class="social-share">
        <div class="share-title">Share this post</div>
        <div class="share-buttons">
            <a href="https://twitter.com/intent/tweet?text=A Comprehensive Guide to fMRI Data Preprocessing&url=http://localhost:4000/blog/fmri-preprocessing-guide/" 
               target="_blank" class="share-button twitter" title="Share on Twitter">
                <i class="fab fa-twitter"></i>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/blog/fmri-preprocessing-guide/"
               target="_blank" class="share-button facebook" title="Share on Facebook">
                <i class="fab fa-facebook-f"></i>
            </a>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/blog/fmri-preprocessing-guide/&title=A Comprehensive Guide to fMRI Data Preprocessing"
               target="_blank" class="share-button linkedin" title="Share on LinkedIn">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </div>
    </div>

    
<nav class="post-navigation">
    <div class="nav-links">
        
        <div class="nav-previous">
            <a href="/jjing-neuro/blog/science-art-intersection/" rel="prev">
                <span class="nav-subtitle">Previous Post</span>
                <span class="nav-title">科学与艺术的交融: 从神经科学视角看创造力</span>
            </a>
        </div>
        

        
    </div>
</nav>
 

    
    <div class="related-posts">
        <h3>Related Posts</h3>
        <ul>
            
            <li>
                <a href="/jjing-neuro/blog/science-art-intersection/">
                    科学与艺术的交融: 从神经科学视角看创造力
                    <small>May 17, 2025</small>
                </a>
            </li>
            
            <li>
                <a href="/jjing-neuro/blog/website-creation-overview/">
                    Website Creation: Journey and Overview
                    <small>May 17, 2025</small>
                </a>
            </li>
            
        </ul>
    </div>
    

    
</article>

<div class="back-to-top" id="back-to-top">
    <i class="fas fa-arrow-up"></i>
</div>

<script src="/jjing-neuro/assets/js/optimization.js"></script>
<script>
// Back to top button
const backToTop = document.getElementById('back-to-top');
window.addEventListener('scroll', () => {
    if (window.scrollY > 300) {
        backToTop.classList.add('show');
    } else {
        backToTop.classList.remove('show');
    }
});

backToTop.addEventListener('click', () => {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
});

// Image zoom
document.querySelectorAll('.post-content img').forEach(img => {
    img.addEventListener('click', () => {
        img.classList.toggle('zoomed');
    });
});

document.addEventListener('DOMContentLoaded', function() {
    // Generate table of contents
    const content = document.querySelector('.post-content');
    const toc = document.getElementById('toc-content');
    const headings = content.querySelectorAll('h2, h3, h4');
    
    if (headings.length > 0) {
        const tocList = document.createElement('ul');
        
        headings.forEach((heading, index) => {
            // Add ID for anchor links
            heading.id = `heading-${index}`;
            
            const li = document.createElement('li');
            const a = document.createElement('a');
            
            a.href = `#${heading.id}`;
            a.textContent = heading.textContent;
            a.style.paddingLeft = `${(heading.tagName.charAt(1) - 2) * 15}px`;
            
            li.appendChild(a);
            tocList.appendChild(li);
            
            // Smooth scroll when clicking on TOC items
            a.addEventListener('click', (e) => {
                e.preventDefault();
                heading.scrollIntoView({ behavior: 'smooth' });
            });
        });
        
        toc.appendChild(tocList);
    } else {
        document.getElementById('toc').style.display = 'none';
    }
    
    // 检查页面中的h1标题
    const pageTitle = document.querySelector('.post-title').textContent.trim();
    const contentH1s = Array.from(content.querySelectorAll('h1'));
    
    contentH1s.forEach(h1 => {
        // 如果内容中的h1标题与页面标题相同或相似，则隐藏它
        if (h1.textContent.trim() === pageTitle || 
            h1.textContent.trim().includes(pageTitle) || 
            pageTitle.includes(h1.textContent.trim())) {
            h1.style.display = 'none';
            console.log('隐藏了重复的标题:', h1.textContent);
        }
    });
});
</script>

<style>
.post {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.post-header {
    text-align: center;
    margin-bottom: 40px;
}

.post-image {
    margin: -20px -20px 30px;
    overflow: hidden;
    border-radius: 8px;
}

.post-image img {
    width: 100%;
    height: auto;
    display: block;
}

.post-title {
    font-size: 2.5em;
    margin: 20px 0;
    color: var(--heading-color);
}

.post-meta {
    color: var(--meta-color);
    font-size: 0.9em;
    margin-bottom: 20px;
}

.post-meta i {
    margin-right: 5px;
}

.post-categories, .post-tags {
    margin-top: 1em;
}

.category, .tag {
    display: inline-block;
    padding: 0.3em 0.8em;
    margin: 0.2em;
    border-radius: 15px;
    text-decoration: none;
    font-size: 0.9em;
}

.category {
    background: #e3f2fd;
    color: #1976d2;
}

.tag {
    background: #f5f5f5;
    color: #616161;
}

.post-wrapper {
    display: flex;
    gap: 40px;
    position: relative;
}

.table-of-contents {
    position: sticky;
    top: 20px;
    width: 250px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    padding: 20px;
    background: var(--toc-bg, #f8f8f8);
    border-radius: 8px;
    font-size: 0.9em;
}

.toc-title {
    font-weight: bold;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid var(--border-color);
}

.post-content {
    flex: 1;
    min-width: 0;
    line-height: 1.8;
    font-size: 1.1em;
}

.social-share {
    text-align: center;
    margin: 3rem 0;
    padding: 1.5rem 0;
    border-top: 1px solid var(--border-color, #eee);
}

.share-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--heading-color, #333);
    position: relative;
    display: inline-block;
}

.share-title:before, .share-title:after {
    content: "";
    position: absolute;
    height: 1px;
    background: var(--border-color, #eee);
    top: 50%;
    width: 50px;
}

.share-title:before {
    right: 100%;
    margin-right: 15px;
}

.share-title:after {
    left: 100%;
    margin-left: 15px;
}

.share-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1rem;
}

.share-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    transition: all 0.3s ease;
    color: white;
}

.share-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.twitter {
    background-color: #1DA1F2;
}

.facebook {
    background-color: #4267B2;
}

.linkedin {
    background-color: #0077B5;
}

.related-posts {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 2px solid var(--border-color);
}

.related-posts h3 {
    margin-bottom: 20px;
}

.related-posts ul {
    list-style: none;
    padding: 0;
}

.related-posts li {
    margin: 15px 0;
}

.related-posts a {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-radius: 8px;
    text-decoration: none;
    color: var(--text-color);
    transition: background-color 0.3s ease;
}

.related-posts a:hover {
    background-color: var(--hover-bg, #f5f5f5);
}

.related-posts small {
    color: var(--meta-color);
}

.post-navigation {
    margin: 3rem 0;
    padding: 0;
    border-top: 1px solid var(--border-color, #eee);
    border-bottom: 1px solid var(--border-color, #eee);
}

.nav-links {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
}

.nav-previous, .nav-next {
    flex: 1;
    min-width: 250px;
    padding: 1.5rem 0;
}

.nav-next {
    text-align: right;
    border-left: 1px solid var(--border-color, #eee);
}

.nav-subtitle {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--meta-color, #666);
    margin-bottom: 0.5rem;
}

.nav-title {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--heading-color, #333);
    transition: color 0.3s ease;
}

.nav-previous a, .nav-next a {
    text-decoration: none;
    display: block;
    transition: all 0.3s ease;
    padding: 0 1rem;
}

.nav-previous a:hover .nav-title, 
.nav-next a:hover .nav-title {
    color: var(--link-color, #4263eb);
}

.nav-previous a:hover, 
.nav-next a:hover {
    transform: translateY(-2px);
}

.back-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--link-color);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.back-to-top.show {
    opacity: 1;
    visibility: visible;
}

.reading-progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    height: 3px;
    background: var(--link-color);
    z-index: 1000;
    transition: width 0.1s ease;
}

@media (max-width: 1024px) {
    .post-wrapper {
        flex-direction: column;
    }

    .table-of-contents {
        position: relative;
        width: 100%;
        margin-bottom: 20px;
    }
}

@media (max-width: 768px) {
    .post {
        padding: 15px;
    }

    .post-title {
        font-size: 2em;
    }

    .post-content {
        font-size: 1em;
    }

    .post-meta {
        flex-direction: column;
        align-items: center;
    }

    .table-of-contents {
        margin: 1rem -1rem;
        border-radius: 0;
    }

    .nav-links {
        flex-direction: column;
    }
    
    .nav-next {
        text-align: left;
        border-left: none;
        border-top: 1px solid var(--border-color, #eee);
    }
    
    .share-title:before, .share-title:after {
        width: 30px;
    }
}
</style>

        </main>
        
        <!-- Site Footer -->
<footer class="site-footer">
    <div class="footer-content">
        <div class="footer-center">
            <span class="copyright">© 2025 Jim Jing</span>
            <a href="/jjing-neuro/feed.xml" target="_blank" class="rss-link" aria-label="RSS Feed">
                <i class="fa-solid fa-rss"></i>
            </a>
        </div>
    </div>
</footer>

<style>
.site-footer {
    position: relative;
    bottom: 0;
    width: 100%;
    padding: 1rem 0;
    background-color: var(--background-color);
    border-top: 1px solid var(--border-color);
    margin-top: 2rem;
}

.footer-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    display: flex;
    justify-content: center;
    align-items: center;
}

.footer-center {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.copyright {
    color: var(--text-color);
    font-size: 0.9rem;
}

.rss-link {
    color: var(--text-color);
    font-size: 1.1rem;
    transition: color 0.3s ease;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.rss-link:hover {
    color: var(--link-color);
}

@media (max-width: 768px) {
    .footer-center {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
    }
}
</style>

    </div>

    <style>
        .header-content {
            text-align: center;
            margin-bottom: 2em;
            padding: 2em 1em;
        }
        
        .header-content h1 {
            font-size: 2.5em;
            color: var(--heading-color);
            margin-bottom: 0.5em;
        }
        
        .bio {
            font-size: 1.2em;
            color: var(--text-color);
            margin: 1em 0;
            line-height: 1.6;
        }
        
        .motto {
            font-size: 1.1em;
            color: var(--meta-color);
            margin: 1.5em 0;
            font-style: italic;
            line-height: 1.8;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>

    <!-- Theme Switching -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const html = document.documentElement;
            const icon = document.querySelector('#dark-mode-toggle i');

            // Initialize theme
            function initTheme() {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    html.classList.add('dark');
                    icon.className = 'fas fa-sun';
                }
            }

            // Toggle theme function
            function toggleTheme() {
                const isDark = html.classList.contains('dark');
                
                if (isDark) {
                    html.classList.remove('dark');
                    icon.className = 'fas fa-moon';
                    localStorage.setItem('theme', 'light');
                } else {
                    html.classList.add('dark');
                    icon.className = 'fas fa-sun';
                    localStorage.setItem('theme', 'dark');
                }
            }

            // Add click event listener
            darkModeToggle.addEventListener('click', toggleTheme);

            // Initialize theme on page load
            initTheme();

            // Log initial state for debugging
            console.log('Theme initialized:', {
                'isDark': html.classList.contains('dark'),
                'savedTheme': localStorage.getItem('theme'),
                'prefersDark': window.matchMedia('(prefers-color-scheme: dark)').matches
            });
        });
    </script>
    
    <!-- 修复重复标题问题的脚本 -->
    <script src="/jjing-neuro/assets/js/fix-duplicate-titles.js"></script>
</body>
</html>

